---
title: "Agricultural trade data processing"
output: html_document
date: "July 9, 2015"
---

```{r, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(list(echo = FALSE,
                           eval = TRUE,
                           cache = FALSE,
                           warning = FALSE,
                           message = FALSE,
                           fig.height = 10,
                           fig.width = 12))
```

Last update: `r Sys.time()`

```{r options}

# if(Sys.getenv("HOSTNAME") != "matrunichstation") stop("Sorry, local database is used for compilation")

subdir <- "OrangeBook"
sourcedir <- "tradeR"
options(width = 120)
suppressPackageStartupMessages(library(dplyr))
library(ggplot2)


source(file.path(Sys.getenv("HOME"), "r_adhoc", "trade_prevalid_testing", "setupconnection.R"))

if(length(lapply(dir(file.path(Sys.getenv("HOME"), "r_adhoc", "privateFAO", subdir, sourcedir), 
                     full.names = T), 
                 source)) == 0) stop("Files for sourcing not found")

trade_src <- src_postgres("sws_data", "localhost", 5432, "trade", .pwd, 
                          options = "-c search_path=ess")

cttl <- tbl(trade_src, sql("select * from tariffline"))




```


# Raw trade data

FAO receives data on trade flows from [United Nations Statistical Division](http://unstats.un.org/unsd/default.htm). The division runs  [Commodity Trade Statistics Database UN Comtrade](http://unstats.un.org/unsd/comtrade_announcement.htm)  "It stores standardised official annual trade statistics reported by countries and reflecting international merchandise flows detailed by commodity and partner country with coverage reaching up to 99 percent of world merchandise trade[^comtrade_ann]". 

[^comtrade_ann]: http://unstats.un.org/unsd/comtrade_announcement.htm Comtrade Announcement

One can freely download this standardised statistics from the [open data base](http://comtrade.un.org/data/). Statistical Division of FAO gets unstandardised data.

```{r example_raw_data}
tbl(trade_src, sql("select 
year, reporter, partner, hs, flow, weight, qty, qunit, value 
 from tariffline
where year = '2011' and 
reporter = '842' and flow = '1' order by random() limit 10")) %>% 
  collect()  %>% 
  printTab(caption = "Random sample of import trade flows of 2011 year, reported by the US")
```

This is an example of unstandardised data on trade inflows in 2011, reported by the United States. Reporters and trade partners are represented with three-digit numerical [codes](http://unstats.un.org/unsd/methods/m49/m49.htm) used by the Statistics Division of the United Nations. Trade commodities are classified with extended Harmonized Commodity Description and Coding System (HS)[^hs_about] maintained by the World Customs Organization[^wto].

[^hs_about]: http://www.wcoomd.org/en/topics/nomenclature/overview/what-is-the-harmonized-system.aspx What is the Harmonized System (HS)?
[^wto]: http://www.wcoomd.org/en.aspx World Customs Organization

Weight is measured in kilograms and value in US dollars. Quantity (qty column) is an optional alternative for weight. It could be measured in different units (qunit column). See full list of possible units and their descriptions in Annex I of Quantity and Weight Data in UN Comtrade[^un_units].

[^un_units]: http://unstats.un.org/unsd/tradekb/Knowledgebase/Quantity-and-Weight-Data-in-UN-Comtrade Quantity and Weight Data in UN Comtrade

## Country-specific HS commodity codes

Harmonized system classification is declared by WCO up to 6 digits. A country may extend HS to more detailed level  to better respond to local circumstances. Let's compare differencies in codes under subheading 0202 Meat of bovine animals, frozen between the US and Brazil[^meta_copyright].

[^meta_copyright]: http://madb.europa.eu Descriptions of country-specific HS-codes are provided by Market Access Database and copyrighted by Mendel Verlag, Germany.

```{r hscodes_us}
getMadbExport("US", "0202") %>% 
  mutate(desc = stringr::str_replace(desc, "and entered pursuant to its provisions", "...")) %>% 
  rename(Description = desc) %>% 
  printTab(caption = "Extension of HS codes by the US")

getMadbExport("BR", "0202") %>% 
  rename(Description = desc) %>% 
  printTab(caption = "Extension of HS codes by Brazil")
```

The set of HS-codes from the US is wider, than Brazilian one. For boneless meat Brazil doesn't extend standard code 0202.30, when the US use here seven additional codes.

## Country codes

### Codes of reporters

Area codes of reporters are standardized by the Statistical Department. The SD follows _in general_ the United Nations Standard Country or Area Codes for Statistical Use[^trade_book]. The code scheme used by the SD[^comtradesource] is slightly modified from the official one[^officialsource]. For example the official scheme offers code 840 for the US, when the modified version uses 842.

[^comtradesource]: http://comtrade.un.org/data/doc/api/ The UN Comtrade data extraction API

[^trade_book]: http://comtrade.un.org/pb/ The United Nations Statistics Division (2015). The 2014 International Trade Statistics Yearbook, Volume I - Trade by Country, xix.

[^officialsource]: http://unstats.un.org/unsd/methods/m49/m49alpha.htm Countries or areas, codes and abbreviations 

### Codes of partners

Partners' codes in Tariffline data are not standardised and presented as they were reported by countries. Reporters can use as standard version of codes, so the version of the Statistical Department. For example, in Tariffline data there are 27 country codes which are not presented in official scheme and 40 codes not covered by the modified version.[^m49]

[^m49]: http://rpubs.com/malexan/m49 Matrunich A. (2015). M49 country codes in Tariffline

# Validation of trade data

### Self-trade

There are cases when a country reports itself as a partner to exports or imports. Such situations can occur due to mistakes or when an entrep√¥t exists.

In case of the US 2011 there are no cases of self-trade.


## Detection of outliers

## Imputing of missing quantities and replacement of outliers

The United Nations collect 
```{r}
noqty <- data.frame(hs = getAgriHSCodes(), stringsAsFactors = F) %>% 
  inner_join(tbl(trade_src, sql("select 
year, reporter, partner, hs, flow, weight, qty, qunit, value 
 from tariffline
where year = '2011' and 
reporter = '842' and weight is null and qty is null")) %>% 
  collect()  %>% 
  mutate(hs6 = stringr::str_extract(hs, "^.{6}"),
         hs2 = stringr::str_extract(hs, "^.{2}")),
by = c("hs" = "hs6")) %>% 
  filter(hs2 %in% c('02', '10', '15'))

```


# Aggregation of trade data

## Reliability index

